<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last.fm Album Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --base: #C4E0E0;
            --contrast: #F090B5;
            --primary: #4A1DC0;
            --secondary: #F7F7F7;
            --tertiary: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Martian Mono', monospace;
            color: var(--primary);
            background: var(--base);
            font-size: 13px;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 5px 5px 0 var(--primary);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .form-section {
            margin-bottom: 16px;
        }

        .form-section label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 12px;
            color: var(--primary);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-family: 'Martian Mono', monospace;
            font-size: 12px;
            background: white;
            color: var(--primary);
            transition: all 0.2s;
            box-shadow: 3px 3px 0 var(--primary);
        }

        input:focus,
        select:focus {
            outline: none;
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--primary);
        }

        .btn,
        button[type="submit"] {
            padding: 10px 18px;
            background: var(--contrast);
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-family: 'Martian Mono', monospace;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--primary);
            box-shadow: 3px 3px 0 var(--primary);
            text-transform: lowercase;
            width: 100%;
        }

        .btn:hover,
        button[type="submit"]:hover {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--primary);
        }

        .btn:active,
        button[type="submit"]:active {
            transform: translate(3px, 3px);
            box-shadow: 0 0 0 var(--primary);
        }

        .btn:disabled,
        button[type="submit"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 var(--primary);
        }

        .tab:hover {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--primary);
        }

        .tab.active {
            background: var(--contrast);
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1);
        }

        .filter-section {
            display: none;
        }

        .filter-section.active {
            display: block;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .date-range-separator {
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }

        .options-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--contrast);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 10px;
            color: var(--primary);
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--base);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Initial Scan Progress */
        .initial-scan-progress {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 5px 5px 0 var(--primary);
        }

        .initial-scan-header {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .initial-scan-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .initial-scan-stat {
            background: rgba(240, 144, 181, 0.2);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .initial-scan-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .initial-scan-stat-label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .initial-scan-progress-bar {
            background: var(--base);
            border: 2px solid var(--primary);
            border-radius: 8px;
            height: 32px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .initial-scan-progress-fill {
            background: var(--contrast);
            height: 100%;
            transition: width 0.3s ease;
            border-right: 2px solid var(--primary);
        }

        .initial-scan-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 11px;
            color: var(--primary);
        }

        .initial-scan-message {
            text-align: center;
            font-size: 11px;
            color: var(--primary);
            opacity: 0.7;
        }

        /* Stop Early Button */
        .stop-early-section {
            background: rgba(196, 224, 224, 0.3);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
        }

        .stop-early-section p {
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .stop-early-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-family: 'Martian Mono', monospace;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 var(--primary);
        }

        .stop-early-btn:hover {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--primary);
        }

        /* Album card fade-in animation */
        @keyframes albumFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .album-card.new {
            animation: albumFadeIn 0.4s ease-out;
        }

        .error {
            background: #FF6B6B;
            color: white;
            padding: 15px;
            border: 3px solid #d93636;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            box-shadow: 4px 4px 0 #d93636;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .results-title h2 {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 4px;
            font-weight: 700;
        }

        .results-subtitle {
            font-size: 11px;
            color: var(--primary);
            opacity: 0.7;
        }

        .results-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 6px;
            color: var(--primary);
            font-family: 'Martian Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 var(--primary);
        }

        .sort-btn:hover {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--primary);
        }

        .sort-btn.active {
            background: var(--contrast);
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1);
        }

        .view-toggle {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }

        .view-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            font-family: 'Martian Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 var(--primary);
        }

        .view-btn:hover {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--primary);
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            padding: 0 16px;
        }

        .album-card {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 var(--primary);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .album-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 var(--primary);
        }

        .album-rank {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            font-weight: 700;
            font-size: 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .album-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: var(--base);
            display: block;
        }

        .album-info {
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            justify-content: space-between;
        }

        .album-name {
            font-weight: 700;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--primary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        .album-artist {
            color: var(--primary);
            font-size: 11px;
            margin-bottom: 8px;
            opacity: 0.7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .album-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            padding-top: 8px;
            border-top: 2px solid var(--base);
            gap: 6px;
        }

        .album-playcount {
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }

        .album-year {
            color: var(--primary);
            opacity: 0.6;
            font-weight: 600;
        }

        body.collage-view .albums-grid {
            gap: 0;
        }

        body.collage-view .album-card {
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        body.collage-view .album-card:hover {
            transform: none;
            box-shadow: none;
        }

        body.collage-view .album-info {
            display: none;
        }

        .download-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid var(--base);
        }

        .download-btn {
            background: var(--primary);
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            font-size: 16px;
            color: var(--primary);
        }

        .no-results strong {
            display: block;
            font-size: 20px;
            margin-bottom: 8px;
        }

        /* Scan Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scan-modal {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            box-shadow: 8px 8px 0 var(--primary);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .scan-modal-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scan-modal-body {
            color: var(--primary);
            margin-bottom: 24px;
        }

        .scan-progress-bar {
            background: var(--base);
            border: 2px solid var(--primary);
            border-radius: 8px;
            height: 32px;
            overflow: hidden;
            margin: 16px 0;
            position: relative;
        }

        .scan-progress-fill {
            background: var(--contrast);
            height: 100%;
            transition: width 0.3s ease;
            border-right: 2px solid var(--primary);
        }

        .scan-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 11px;
            color: var(--primary);
        }

        .scan-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .scan-stat {
            background: rgba(240, 144, 181, 0.2);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .scan-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .scan-stat-label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .scan-modal-actions {
            display: flex;
            gap: 12px;
        }

        .scan-modal-actions .btn {
            flex: 1;
        }

        .insufficient-results-card {
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .insufficient-results-card h3 {
            color: var(--primary);
            font-size: 16px;
            margin-bottom: 12px;
        }

        .insufficient-results-card p {
            color: var(--primary);
            opacity: 0.8;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .scan-more-info {
            background: rgba(196, 224, 224, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 11px;
            color: var(--primary);
            opacity: 0.9;
        }

        .footer {
            text-align: center;
            padding: 20px;
            font-size: 11px;
            color: var(--primary);
            opacity: 0.6;
            margin-top: 40px;
        }

        .footer a {
            color: var(--primary);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .section {
                padding: 18px;
            }

            .albums-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 0 8px;
            }

            .album-card {
                border: 2px solid var(--primary);
                box-shadow: 2px 2px 0 var(--primary);
            }

            .filter-tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
            }

            .options-row {
                grid-template-columns: 1fr;
            }

            .scan-modal {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="section">
            <div class="section-title">‚öôÔ∏è Search Settings</div>
            
            <form id="searchForm">
                <div class="form-section">
                    <label for="username">Last.fm Username:</label>
                    <input 
                        type="text" 
                        id="username" 
                        placeholder="enter your username" 
                        required
                    >
                </div>

                <div class="form-section">
                    <label>Filter By:</label>
                    <div class="filter-tabs">
                        <div class="tab active" data-filter="year">Specific Year</div>
                        <div class="tab" data-filter="decade">Decade</div>
                        <div class="tab" data-filter="range">Date Range</div>
                        <div class="tab" data-filter="all">All Time</div>
                    </div>
                </div>

                <div id="yearFilter" class="filter-section active">
                    <div class="form-section">
                        <label for="year">Year:</label>
                        <input 
                            type="number" 
                            id="year" 
                            placeholder="e.g., 2023" 
                            min="1950" 
                            max="2026"
                        >
                    </div>
                </div>

                <div id="decadeFilter" class="filter-section">
                    <div class="form-section">
                        <label for="decade">Decade:</label>
                        <select id="decade">
                            <option value="">select a decade</option>
                            <option value="2020">2020s</option>
                            <option value="2010">2010s</option>
                            <option value="2000">2000s</option>
                            <option value="1990">1990s</option>
                            <option value="1980">1980s</option>
                            <option value="1970">1970s</option>
                            <option value="1960">1960s</option>
                            <option value="1950">1950s</option>
                        </select>
                    </div>
                </div>

                <div id="rangeFilter" class="filter-section">
                    <div class="form-section">
                        <label>Date Range:</label>
                        <div class="date-range">
                            <input 
                                type="number" 
                                id="yearStart" 
                                placeholder="start year"
                                min="1950" 
                                max="2026"
                            >
                            <span class="date-range-separator">‚Üí</span>
                            <input 
                                type="number" 
                                id="yearEnd" 
                                placeholder="end year"
                                min="1950" 
                                max="2026"
                            >
                        </div>
                    </div>
                </div>

                <div class="options-row">
                    <div class="form-section">
                        <label for="limit">Show:</label>
                        <select id="limit">
                            <option value="4">top 4</option>
                            <option value="10">top 10</option>
                            <option value="20" selected>top 20</option>
                        </select>
                    </div>
                </div>

                <button type="submit" id="submitBtn">üîç Get Top Albums</button>
            </form>
        </div>

        <div id="statsCard" class="section" style="display: none;">
            <div class="section-title">üìä cache statistics</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="totalAlbums">-</div>
                    <div class="stat-label">cached albums</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="lastUpdate">-</div>
                    <div class="stat-label">last updated</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="cacheAge">-</div>
                    <div class="stat-label">hours ago</div>
                </div>
            </div>
        </div>

        <div id="initialScanProgress" class="section initial-scan-progress" style="display: none;">
            <div class="initial-scan-header">
                <span>üîç</span>
                <span id="initialScanTitle">Scanning your library...</span>
            </div>
            <div class="initial-scan-stats">
                <div class="initial-scan-stat">
                    <div class="initial-scan-stat-value" id="initialScanned">0</div>
                    <div class="initial-scan-stat-label">Scanned</div>
                </div>
                <div class="initial-scan-stat">
                    <div class="initial-scan-stat-value" id="initialFound">0</div>
                    <div class="initial-scan-stat-label">Found</div>
                </div>
                <div class="initial-scan-stat">
                    <div class="initial-scan-stat-value" id="initialProgress">0%</div>
                    <div class="initial-scan-stat-label">Progress</div>
                </div>
            </div>
            <div class="initial-scan-progress-bar">
                <div class="initial-scan-progress-fill" id="initialProgressFill" style="width: 0%"></div>
                <div class="initial-scan-progress-text" id="initialProgressText">Starting...</div>
            </div>
            <div class="initial-scan-message" id="initialScanMessage">
                Fetching albums from Last.fm...
            </div>
        </div>

        <div id="loading" class="section" style="display: none;">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p id="loadingMessage">fetching your albums...</p>
                <p id="loadingDetail" style="font-size: 11px; opacity: 0.7; margin-top: 8px;"></p>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" style="display: none;">
            <div class="section">
                <div class="results-header">
                    <div class="results-title">
                        <h2 id="resultsTitle"></h2>
                        <div class="results-subtitle" id="resultsSubtitle"></div>
                    </div>
                    <div class="results-controls">
                        <button class="sort-btn active" data-sort="playcount">most played</button>
                        <button class="sort-btn" data-sort="year">by year</button>
                        <button class="sort-btn" data-sort="name">a-z</button>
                    </div>
                </div>

                <div class="view-toggle">
                    <button class="view-btn active" data-view="card">card view</button>
                    <button class="view-btn" data-view="collage">collage view</button>
                </div>

                <div id="albumsGrid" class="albums-grid"></div>

                <div id="stopEarlySection" class="stop-early-section" style="display: none;">
                    <p><strong>Found what you need?</strong><br>You can stop scanning and use the <span id="stopEarlyCount">0</span> albums found so far.</p>
                    <button class="btn stop-early-btn" id="stopEarlyBtn">‚úã Stop Scan & Use These Results</button>
                </div>

                <div id="insufficientResults" class="insufficient-results-card" style="display: none;">
                    <h3>‚ö†Ô∏è Not enough albums found</h3>
                    <p id="insufficientText">Found <span id="foundCount">0</span> of <span id="targetCount">0</span> albums</p>
                    <div class="scan-more-info">
                        Scanning deeper will check albums <span id="nextRangeText">501-1000</span> in your library. This typically takes 8-12 minutes.
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" id="scanMoreBtn">üîç Scan More Albums</button>
                        <button class="btn btn-secondary" id="skipScanBtn">Skip</button>
                    </div>
                </div>

                <div class="download-section">
                    <button class="btn download-btn" id="downloadBtn">
                        üì∏ Download <span id="downloadType">Cards</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="noResults" class="section" style="display: none;">
            <div class="no-results">
                <strong>‚ö†Ô∏è no albums found</strong>
                <p>try a different filter or update your cache</p>
            </div>
        </div>

        <div class="footer">
            data provided by <a href="https://www.last.fm" target="_blank" rel="noopener">Last.fm</a>
        </div>
    </div>

    <!-- Scan Progress Modal -->
    <div id="scanModal" class="modal-overlay">
        <div class="scan-modal">
            <div class="scan-modal-header">
                <span id="scanIcon">üîç</span>
                <span id="scanTitle">Scanning Albums...</span>
            </div>
            <div class="scan-modal-body">
                <div class="scan-stats">
                    <div class="scan-stat">
                        <div class="scan-stat-value" id="scanProgress">0%</div>
                        <div class="scan-stat-label">Progress</div>
                    </div>
                    <div class="scan-stat">
                        <div class="scan-stat-value" id="scanNewFound">0</div>
                        <div class="scan-stat-label">New Found</div>
                    </div>
                </div>
                
                <div class="scan-progress-bar">
                    <div class="scan-progress-fill" id="progressFill" style="width: 0%"></div>
                    <div class="scan-progress-text" id="progressText">Starting...</div>
                </div>
                
                <p style="font-size: 11px; opacity: 0.7; text-align: center;" id="scanETA">
                    Estimating time...
                </p>
            </div>
            <div class="scan-modal-actions">
                <button class="btn btn-secondary" id="stopScanBtn">‚è∏Ô∏è Stop Scan</button>
            </div>
        </div>
    </div>

    <script>
    const API_URL = '/api/top-albums';
    const STATS_URL = '/api/cache/stats';

    let currentAlbums = [];
    let currentSort = 'playcount';
    let currentView = 'card';
    let currentFilter = '';
    let currentUsername = '';
    let currentLimit = 20;
    let currentRange = { start: 0, end: 500 };
    let activeScanJobId = null;
    let scanEventSource = null;
    let isInitialScanActive = false;
    let initialScanAbortController = null;

    // Filter tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            document.querySelectorAll('.filter-section').forEach(s => s.classList.remove('active'));
            const filterId = tab.dataset.filter + 'Filter';
            const filterSection = document.getElementById(filterId);
            if (filterSection) filterSection.classList.add('active');
        });
    });

    // View toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentView = btn.dataset.view;
            
            if (currentView === 'collage') {
                document.body.classList.add('collage-view');
                document.getElementById('downloadType').textContent = 'Collage';
            } else {
                document.body.classList.remove('collage-view');
                document.getElementById('downloadType').textContent = 'Cards';
            }
        });
    });

    // Form submit
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        currentUsername = document.getElementById('username').value.trim();
        const activeFilter = document.querySelector('.tab.active').dataset.filter;
        currentLimit = parseInt(document.getElementById('limit').value);

        let url = `${API_URL}?user=${encodeURIComponent(currentUsername)}&limit=${currentLimit}`;
        let filterText = 'all time';

        if (activeFilter === 'year') {
            const year = document.getElementById('year').value;
            if (year) {
                url += `&year=${year}`;
                filterText = year;
            }
        } else if (activeFilter === 'decade') {
            const decade = document.getElementById('decade').value;
            if (decade) {
                url += `&decade=${decade}`;
                filterText = `${decade}s`;
            }
        } else if (activeFilter === 'range') {
            const yearStart = document.getElementById('yearStart').value;
            const yearEnd = document.getElementById('yearEnd').value;
            if (yearStart && yearEnd) {
                url += `&yearStart=${yearStart}&yearEnd=${yearEnd}`;
                filterText = `${yearStart}‚Äì${yearEnd}`;
            }
        }

        currentFilter = filterText;
        currentRange = { start: 0, end: 500 };
        
        // Clear previous results
        currentAlbums = [];

        hideAll();
        
        // For real-time users with filters, show progressive scan
        const hasFilter = activeFilter !== 'all';
        
        if (hasFilter) {
            await performProgressiveScan();
        } else {
            // Standard loading for "all time" or cached users
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            
            try {
                await fetchStats(currentUsername);
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to fetch albums`);
                }

                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;

                let albums = data.albums;
                if (activeFilter === 'range') {
                    const yearStart = parseInt(document.getElementById('yearStart').value);
                    const yearEnd = parseInt(document.getElementById('yearEnd').value);
                    albums = albums.filter(a => 
                        a.release_year && 
                        a.release_year >= yearStart && 
                        a.release_year <= yearEnd
                    );
                }

                if (albums && albums.length > 0) {
                    currentAlbums = albums;
                    displayResults(currentUsername, filterText, albums.length);
                    sortAndDisplayAlbums();
                } else {
                    document.getElementById('noResults').style.display = 'block';
                }

            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                showError(err.message);
            }
        }
    });

    async function performProgressiveScan() {
        isInitialScanActive = true;
        // currentAlbums already cleared in submit handler
        
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('initialScanProgress').style.display = 'block';
        document.getElementById('results').style.display = 'block';
        displayResults(currentUsername, currentFilter, 0);
        
        const activeFilter = document.querySelector('.tab.active').dataset.filter;
        
        let url = `${API_URL}?user=${encodeURIComponent(currentUsername)}&limit=${currentLimit}`;
        
        if (activeFilter === 'year') {
            const year = document.getElementById('year').value;
            if (year) url += `&year=${year}`;
        } else if (activeFilter === 'decade') {
            const decade = document.getElementById('decade').value;
            if (decade) url += `&decade=${decade}`;
        } else if (activeFilter === 'range') {
            const yearStart = document.getElementById('yearStart').value;
            const yearEnd = document.getElementById('yearEnd').value;
            if (yearStart && yearEnd) url += `&yearStart=${yearStart}&yearEnd=${yearEnd}`;
        }
        
        initialScanAbortController = new AbortController();
        
        // Simulate progress while backend processes
        const progressInterval = setInterval(() => {
            const current = parseInt(document.getElementById('initialScanned').textContent) || 0;
            if (current < 450) {
                updateInitialScanProgress({
                    scanned: current + 10,
                    total: 500,
                    found: currentAlbums.length,
                    message: 'Scanning your library...'
                });
            }
        }, 500);
        
        try {
            const response = await fetch(url, { signal: initialScanAbortController.signal });
            
            clearInterval(progressInterval);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `HTTP ${response.status}: Failed to fetch albums`);
            }

            const data = await response.json();
            
            updateInitialScanProgress({
                scanned: 500,
                total: 500,
                found: data.albums.length,
                message: 'Complete!'
            });
            
            // Show albums with animation
            if (data.albums && data.albums.length > 0) {
                for (const album of data.albums) {
                    currentAlbums.push(album);
                    addAlbumToGrid(album, currentAlbums.length - 1);
                    await new Promise(r => setTimeout(r, 50)); // Stagger animations
                }
            }
            
            setTimeout(() => {
                document.getElementById('initialScanProgress').style.display = 'none';
                document.getElementById('stopEarlySection').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                isInitialScanActive = false;
                
                displayResults(currentUsername, currentFilter, currentAlbums.length);
                
                if (currentAlbums.length < currentLimit) {
                    showInsufficientResults();
                }
            }, 1000);
            
        } catch (err) {
            clearInterval(progressInterval);
            document.getElementById('initialScanProgress').style.display = 'none';
            document.getElementById('stopEarlySection').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            isInitialScanActive = false;
            
            if (err.name === 'AbortError') {
                showError('Scan cancelled');
            } else {
                showError(err.message);
            }
        }
    }

    function updateInitialScanProgress({ scanned, total, found, message }) {
        const percentage = Math.round((scanned / total) * 100);
        
        document.getElementById('initialScanned').textContent = scanned;
        document.getElementById('initialFound').textContent = found;
        document.getElementById('initialProgress').textContent = `${percentage}%`;
        document.getElementById('initialProgressFill').style.width = `${percentage}%`;
        document.getElementById('initialProgressText').textContent = `${scanned} / ${total}`;
        document.getElementById('initialScanMessage').textContent = message;
    }

    function addAlbumToGrid(album, index) {
        const grid = document.getElementById('albumsGrid');
        const card = document.createElement('div');
        card.className = 'album-card new';
        
        const displayName = album.name || 'Unknown Album';
        const displayArtist = album.artist || 'Unknown Artist';
        const displayUrl = album.url || '#';

        card.onclick = () => {
            if (displayUrl !== '#') window.open(displayUrl, '_blank');
        };

        const rawUrl = album.image;
        const imageUrl = rawUrl && rawUrl.length > 5
            ? `/api/proxy-image?url=${encodeURIComponent(rawUrl)}` 
            : 'https://placehold.co/300x300/C4E0E0/4A1DC0?text=No+Image';

        card.innerHTML = `
            <img 
                src="${imageUrl}" 
                alt="${displayName}"
                class="album-cover"
                crossorigin="anonymous" 
                onerror="this.src='https://placehold.co/300x300/C4E0E0/4A1DC0?text=No+Image'"
            >
            <div class="album-info">
                <div class="album-name" title="${displayName}">${displayName}</div>
                <div class="album-artist" title="${displayArtist}">${displayArtist}</div>
                <div class="album-meta">
                    <span class="album-rank">#${index + 1}</span>
                    <span class="album-playcount">${(album.playcount || 0).toLocaleString()}</span>
                    <span class="album-year">${album.release_year || '?'}</span>
                </div>
            </div>
        `;
        grid.appendChild(card);
        
        // Remove 'new' class after animation
        setTimeout(() => card.classList.remove('new'), 400);
    }

    // Mock getMusicBrainzData for client-side (in real app, this would be a backend call)
    async function getMusicBrainzData(artist, album) {
        // This is a placeholder - in production, this should call your backend
        // For now, return dummy data
        return {
            release_year: 2000 + Math.floor(Math.random() * 25),
            musicbrainz_id: null,
            type: 'Album'
        };
    }

    document.getElementById('stopEarlyBtn').addEventListener('click', () => {
        if (isInitialScanActive && initialScanAbortController) {
            initialScanAbortController.abort();
            document.getElementById('initialScanProgress').style.display = 'none';
            document.getElementById('stopEarlySection').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            isInitialScanActive = false;
        }
    });

    async function fetchStats(username) {
        try {
            const response = await fetch(`${STATS_URL}?user=${username}`);
            if (response.ok) {
                const data = await response.json();
                
                if (data.mode === 'realtime') {
                    console.log('User is in real-time mode (no cache)');
                    document.getElementById('statsCard').style.display = 'none';
                    return;
                }
                
                updateStatsCard(data);
            } else {
                console.log('Could not fetch stats, continuing anyway');
                document.getElementById('statsCard').style.display = 'none';
            }
        } catch (err) {
            console.error('failed to fetch stats:', err);
            document.getElementById('statsCard').style.display = 'none';
        }
    }

    function updateStatsCard(data) {
        document.getElementById('totalAlbums').textContent = data.total_albums || 0;
        
        if (data.last_update_recent) {
            const date = new Date(data.last_update_recent);
            document.getElementById('lastUpdate').textContent = date.toLocaleDateString();
            
            const hours = Math.round((Date.now() - date.getTime()) / 1000 / 60 / 60);
            document.getElementById('cacheAge').textContent = hours;
        } else {
            document.getElementById('lastUpdate').textContent = 'never';
            document.getElementById('cacheAge').textContent = '‚àû';
        }

        document.getElementById('statsCard').style.display = 'block';
    }

    // Sort buttons
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentSort = btn.dataset.sort;
            sortAndDisplayAlbums();
        });
    });

    function sortAndDisplayAlbums() {
        let sorted = currentAlbums.map(album => {
            return {
                ...album,
                displayName: album.album_name || album.name || album.canonical_album,
                displayArtist: album.artist_name || album.artist || album.canonical_artist
            };
        });
        
        if (currentSort === 'playcount') {
            sorted.sort((a, b) => (b.playcount || 0) - (a.playcount || 0));
        } else if (currentSort === 'year') {
            sorted.sort((a, b) => (b.release_year || 0) - (a.release_year || 0));
        } else if (currentSort === 'name') {
            sorted.sort((a, b) => a.displayName.localeCompare(b.displayName));
        }

        displayAlbumCards(sorted);
    }

    function displayResults(username, filterText, count) {
        document.getElementById('resultsTitle').textContent = `üéµ ${username}'s top albums`;
        document.getElementById('resultsSubtitle').textContent = `${filterText} ‚Ä¢ ${count} album${count !== 1 ? 's' : ''}`;
        document.getElementById('results').style.display = 'block';
    }

    function displayAlbumCards(albums) {
        const grid = document.getElementById('albumsGrid');
        grid.innerHTML = '';

        albums.forEach((album, index) => {
            const card = document.createElement('div');
            card.className = 'album-card';
            
            const displayName = album.album_name || album.name || album.canonical_album || 'Unknown Album';
            const displayArtist = album.artist_name || album.artist || album.canonical_artist || 'Unknown Artist';
            const displayUrl = album.url || album.lastfm_url || '#';

            card.onclick = () => {
                if (displayUrl !== '#') window.open(displayUrl, '_blank');
            };

            const rawUrl = (album.image && album.image.length > 5) ? album.image : 
                        (album.image_url && album.image_url.length > 5) ? album.image_url : null;

            const imageUrl = rawUrl 
                ? `/api/proxy-image?url=${encodeURIComponent(rawUrl)}` 
                : 'https://placehold.co/300x300/C4E0E0/4A1DC0?text=No+Image';

            card.innerHTML = `
                <img 
                    src="${imageUrl}" 
                    alt="${displayName}"
                    class="album-cover"
                    crossorigin="anonymous" 
                    onerror="this.src='https://placehold.co/300x300/C4E0E0/4A1DC0?text=No+Image'"
                >
                <div class="album-info">
                    <div class="album-name" title="${displayName}">${displayName}</div>
                    <div class="album-artist" title="${displayArtist}">${displayArtist}</div>
                    <div class="album-meta">
                        <span class="album-rank">#${index + 1}</span>
                        <span class="album-playcount">${(album.playcount || 0).toLocaleString()}</span>
                        <span class="album-year">${album.release_year || '?'}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // Progressive Scanning
    function showInsufficientResults() {
        const card = document.getElementById('insufficientResults');
        document.getElementById('foundCount').textContent = currentAlbums.length;
        document.getElementById('targetCount').textContent = currentLimit;
        
        const nextStart = currentRange.end + 1;
        const nextEnd = currentRange.end + 500;
        document.getElementById('nextRangeText').textContent = `${nextStart}-${nextEnd}`;
        
        card.style.display = 'block';
    }

    document.getElementById('scanMoreBtn').addEventListener('click', async () => {
        const nextStart = currentRange.end + 1;
        const nextEnd = currentRange.end + 500;
        
        const activeFilter = document.querySelector('.tab.active').dataset.filter;
        let filters = {};
        
        if (activeFilter === 'year') {
            const year = document.getElementById('year').value;
            if (year) filters.year = parseInt(year);
        } else if (activeFilter === 'decade') {
            const decade = document.getElementById('decade').value;
            if (decade) filters.decade = parseInt(decade);
        } else if (activeFilter === 'range') {
            const yearStart = document.getElementById('yearStart').value;
            const yearEnd = document.getElementById('yearEnd').value;
            if (yearStart && yearEnd) {
                filters.yearStart = parseInt(yearStart);
                filters.yearEnd = parseInt(yearEnd);
            }
        }
        
        try {
            const response = await fetch('/api/scan-more', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: currentUsername,
                    startRange: nextStart,
                    endRange: nextEnd,
                    filters: filters,
                    targetLimit: currentLimit,
                    currentCount: currentAlbums.length
                })
            });
            
            if (!response.ok) throw new Error('Failed to start scan');
            
            const data = await response.json();
            activeScanJobId = data.jobId;
            
            document.getElementById('insufficientResults').style.display = 'none';
            showScanModal();
            connectToScanStream();
            
        } catch (err) {
            showError('Failed to start scan: ' + err.message);
        }
    });

    document.getElementById('skipScanBtn').addEventListener('click', () => {
        document.getElementById('insufficientResults').style.display = 'none';
    });

    document.getElementById('stopScanBtn').addEventListener('click', async () => {
        if (!activeScanJobId) return;
        
        try {
            const response = await fetch(`/api/scan-stop/${activeScanJobId}`, {
                method: 'POST'
            });
            
            if (scanEventSource) {
                scanEventSource.close();
                scanEventSource = null;
            }
            
        } catch (err) {
            console.error('Failed to stop scan:', err);
        }
    });

    function showScanModal() {
        document.getElementById('scanModal').classList.add('active');
        document.getElementById('scanIcon').textContent = 'üîç';
        document.getElementById('scanTitle').textContent = 'Scanning Albums...';
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = 'Starting...';
        document.getElementById('scanProgress').textContent = '0%';
        document.getElementById('scanNewFound').textContent = '0';
        document.getElementById('scanETA').textContent = 'Estimating time...';
    }

    function connectToScanStream() {
        scanEventSource = new EventSource(`/api/scan-stream/${activeScanJobId}`);
        
        scanEventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateScanProgress(data);
            
            if (data.status === 'complete' || data.status === 'stopped' || data.status === 'error') {
                scanEventSource.close();
                scanEventSource = null;
                handleScanComplete(data);
            }
        };
        
        scanEventSource.onerror = () => {
            console.error('SSE connection error');
            scanEventSource.close();
            scanEventSource = null;
        };
    }

    function updateScanProgress(data) {
        const percentage = data.progress.percentage || 0;
        
        document.getElementById('progressFill').style.width = `${percentage}%`;
        document.getElementById('progressText').textContent = 
            `${data.progress.current} / ${data.progress.total} albums`;
        document.getElementById('scanProgress').textContent = `${percentage}%`;
        document.getElementById('scanNewFound').textContent = data.newAlbumsCount || 0;
        
        if (data.timeRemaining) {
            document.getElementById('scanETA').textContent = 
                `‚è±Ô∏è ${data.timeRemaining} remaining`;
        }
        
        // Add new albums to display in real-time
        if (data.foundAlbums && data.foundAlbums.length > currentAlbums.length) {
            const newAlbums = data.foundAlbums.slice(currentAlbums.length);
            currentAlbums.push(...newAlbums);
            sortAndDisplayAlbums();
        }
    }

    function handleScanComplete(data) {
        if (data.status === 'complete') {
            document.getElementById('scanIcon').textContent = '‚úÖ';
            document.getElementById('scanTitle').textContent = 'Scan Complete!';
            document.getElementById('stopScanBtn').textContent = '‚úÖ Done';
            
            setTimeout(() => {
                document.getElementById('scanModal').classList.remove('active');
            }, 2000);
            
        } else if (data.status === 'stopped') {
            document.getElementById('scanIcon').textContent = '‚è∏Ô∏è';
            document.getElementById('scanTitle').textContent = 'Scan Stopped';
            document.getElementById('stopScanBtn').textContent = 'Close';
            
        } else if (data.status === 'error') {
            document.getElementById('scanIcon').textContent = '‚ùå';
            document.getElementById('scanTitle').textContent = 'Scan Error';
            showError(data.error || 'Scan failed');
        }
        
        activeScanJobId = null;
        currentRange.end += 500;
        
        // Update results subtitle
        displayResults(currentUsername, currentFilter, currentAlbums.length);
        
        // Check if we still need more
        if (currentAlbums.length < currentLimit && currentRange.end < 2000) {
            setTimeout(() => {
                document.getElementById('scanModal').classList.remove('active');
                showInsufficientResults();
            }, 3000);
        }
    }

    // Download functionality
    document.getElementById('downloadBtn').addEventListener('click', async () => {
        const btn = document.getElementById('downloadBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ generating...';

        try {
            if (currentView === 'card') {
                await downloadCardView();
            } else {
                await downloadCollageView();
            }
        } catch (err) {
            console.error('Download error:', err);
            alert('Failed to generate image. Please try again.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `üì∏ Download <span id="downloadType">${currentView === 'card' ? 'Cards' : 'Collage'}</span>`;
        }
    });

    async function downloadCardView() {
        const username = document.getElementById('username').value.trim();
        const grid = document.getElementById('albumsGrid');
        const count = currentAlbums.length;

        const wrapper = document.createElement('div');
        wrapper.style.backgroundColor = '#C4E0E0';
        wrapper.style.padding = '40px';
        wrapper.style.fontFamily = '"Martian Mono", monospace';
        wrapper.style.width = '1400px';
        wrapper.style.maxWidth = '1400px';

        const title = document.createElement('div');
        title.style.textAlign = 'center';
        title.style.marginBottom = '30px';
        title.innerHTML = `
            <div style="font-size: 48px; font-weight: 700; color: #4A1DC0; margin-bottom: 10px;">
                My Top ${count} Albums of ${currentFilter}
            </div>
        `;
        wrapper.appendChild(title);

        const gridClone = grid.cloneNode(true);
        gridClone.style.backgroundColor = 'transparent';
        gridClone.style.gridTemplateColumns = 'repeat(5, 1fr)';
        wrapper.appendChild(gridClone);

        const watermark = document.createElement('div');
        watermark.style.textAlign = 'center';
        watermark.style.marginTop = '30px';
        watermark.style.fontSize = '20px';
        watermark.style.color = '#4A1DC0';
        watermark.textContent = 'sortedsongs.com/tools/album-explorer';
        wrapper.appendChild(watermark);
        
        wrapper.style.position = 'absolute';
        wrapper.style.left = '-9999px';
        document.body.appendChild(wrapper);
        
        const canvas = await html2canvas(wrapper, {
            backgroundColor: '#C4E0E0',
            scale: 2,
            logging: false,
            useCORS: true,
            width: wrapper.offsetWidth,
            height: wrapper.offsetHeight
        });
        
        document.body.removeChild(wrapper);

        downloadCanvas(canvas, `${username}_cards_${currentFilter.replace(/\s+/g, '_')}.png`);
    }

    async function downloadCollageView() {
        const username = document.getElementById('username').value.trim();
        const albums = currentAlbums;
        const count = albums.length;
        
        let cols, rows;
        if (count === 4) {
            cols = 2; rows = 2;
        } else if (count === 10) {
            cols = 5; rows = 2;
        } else if (count === 20) {
            cols = 5; rows = 4;
        } else {
            cols = Math.ceil(Math.sqrt(count));
            rows = Math.ceil(count / cols);
        }

        const albumSize = 400;
        const headerHeight = 120;
        const footerHeight = 60;

        const canvas = document.createElement('canvas');
        canvas.width = cols * albumSize;
        canvas.height = rows * albumSize + headerHeight + footerHeight;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = '#C4E0E0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#4A1DC0';
        ctx.font = 'bold 48px "Martian Mono"';
        ctx.textAlign = 'center';
        ctx.fillText(`My Top ${count} Albums of ${currentFilter}`, canvas.width / 2, 70);

        const imagePromises = albums.slice(0, count).map((album, index) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                const rawUrl = album.image || album.image_url;
                
                img.onload = () => {
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    const x = col * albumSize;
                    const y = row * albumSize + headerHeight;
                    ctx.drawImage(img, x, y, albumSize, albumSize);
                    resolve();
                };
                
                img.onerror = () => {
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    const x = col * albumSize;
                    const y = row * albumSize + headerHeight;
                    ctx.fillStyle = '#4A1DC0';
                    ctx.fillRect(x, y, albumSize, albumSize);
                    ctx.fillStyle = '#C4E0E0';
                    ctx.font = '24px "Martian Mono"';
                    ctx.textAlign = 'center';
                    ctx.fillText('No Image', x + albumSize / 2, y + albumSize / 2);
                    resolve();
                };
                
                if (rawUrl && rawUrl.length > 5) {
                    img.src = `/api/proxy-image?url=${encodeURIComponent(rawUrl)}`;
                } else {
                    img.onerror();
                }
            });
        });

        await Promise.all(imagePromises);

        ctx.fillStyle = '#4A1DC0';
        ctx.font = '18px "Martian Mono"';
        ctx.textAlign = 'center';
        ctx.fillText('sortedsongs.com/tools/album-explorer', canvas.width / 2, canvas.height - 25);

        downloadCanvas(canvas, `${username}_collage_${currentFilter.replace(/\s+/g, '_')}.png`);
    }

    function downloadCanvas(canvas, filename) {
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }, 'image/png');
    }

    function hideAll() {
        document.getElementById('error').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('noResults').style.display = 'none';
        document.getElementById('insufficientResults').style.display = 'none';
    }

    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = '‚ö†Ô∏è ' + message;
        errorDiv.style.display = 'block';
    }

    // Auto-resize for WordPress iframe
    function sendHeight() {
        const height = document.documentElement.scrollHeight;
        window.parent.postMessage({ type: 'resize', height: height }, '*');
    }

    window.addEventListener('load', sendHeight);
    window.addEventListener('resize', sendHeight);

    const observer = new MutationObserver(sendHeight);
    observer.observe(document.body, { childList: true, subtree: true, attributes: true });
</script>
</body>
</html>