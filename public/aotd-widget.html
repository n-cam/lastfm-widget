<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Albums - Decade</title>
    <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Martian Mono', monospace; background: transparent; padding: 10px; overflow: hidden; }
        .widget-title { font-size: 24px; font-weight: 600; color: #4A1DC0; margin-bottom: 20px; text-transform: lowercase; }
        .loading { text-align: center; padding: 40px; color: #4A1DC0; }
        .albums-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; }
        .album-card { background: white; border: 2px solid #4A1DC0; border-radius: 12px; overflow: hidden; box-shadow: 2px 4px 0 #4A1DC0; cursor: pointer; }
        .album-cover { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; background: #eee; }
        .album-info { padding: 10px; }
        .album-name { font-weight: 700; font-size: 11px; color: #4A1DC0; line-height: 1.2; margin-bottom: 4px; }
        .album-artist { font-size: 10px; color: #4A1DC0; opacity: 0.7; }
        .error { color: red; text-align: center; padding: 20px; }
        @media (max-width: 768px) { .albums-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } }
    </style>
</head>
<body>

    <div id="widget-content">
        <div class="widget-title" id="widgetTitle">top albums</div>
        
        <div id="loading" class="loading">loading albums...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="albumsGrid" class="albums-grid"></div>
        <div id="noResults" style="display: none; text-align: center; color: #4A1DC0;">no albums found for this decade</div>
    </div>

    <script>
        // Use a function to ensure we don't run until the elements exist
        async function initWidget() {
            const params = new URLSearchParams(window.location.search);
            const user = params.get('user') || 'nikzx';
            const start = params.get('startYear');
            const end = params.get('endYear');
            const limit = params.get('limit') || 24;

            const titleEl = document.getElementById('widgetTitle');
            const gridEl = document.getElementById('albumsGrid');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const noResultsEl = document.getElementById('noResults');

            // Construct URL matching your server's API: yearStart and yearEnd
            const apiUrl = `https://lastfm-widget.onrender.com/api/top-albums?user=${user}&yearStart=${start}&yearEnd=${end}&limit=${limit}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Server returned ${response.status}`);
                
                const data = await response.json();
                loadingEl.style.display = 'none';

                if (data.albums && data.albums.length > 0) {
                    // Calculate actual count and format the decade range
                    const actualCount = data.albums.length;
                    titleEl.textContent = `my top ${actualCount} albums from ${start} to ${end}`;
                    
                    data.albums.forEach(album => {
                        const card = document.createElement('div');
                        card.className = 'album-card';
                        card.onclick = () => window.open(album.url, '_blank');
                        card.innerHTML = `
                            <img src="${album.image || ''}" class="album-cover" onerror="this.src='https://via.placeholder.com/300'">
                            <div class="album-info">
                                <div class="album-name">${album.name}</div>
                                <div class="album-artist">${album.artist}</div>
                            </div>
                        `;
                        gridEl.appendChild(card);
                    });

                    // Wait for images to render then tell parent to resize
                    setTimeout(() => {
                        const height = document.getElementById('widget-content').offsetHeight + 40;
                        window.parent.postMessage({ type: 'resize', height: height }, '*');
                    }, 500);

                } else {
                    noResultsEl.style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = "failed to load decade data";
            }
        }

        // Run the script
        initWidget();
    </script>
</body>
</html>