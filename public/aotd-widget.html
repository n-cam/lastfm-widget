<script>
    // Wrap everything in an event listener to ensure the HTML is ready
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('user') || 'nikzx';
        const limit = urlParams.get('limit') || 24;
        
        const year = urlParams.get('year');
        const startYear = urlParams.get('startYear');
        const endYear = urlParams.get('endYear');
        
        const API_URL = 'https://lastfm-widget.onrender.com/api/top-albums';

        // Elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const gridEl = document.getElementById('albumsGrid');
        const noResultsEl = document.getElementById('noResults');
        const titleEl = document.getElementById('widgetTitle');

        async function loadAlbums() {
            try {
                let url = `${API_URL}?user=${username}&limit=${limit}`;
                
                if (year) {
                    url += `&year=${year}`;
                } else if (startYear && endYear) {
                    url += `&yearStart=${startYear}&yearEnd=${endYear}`;
                }

                console.log('Fetching:', url);
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();

                // Hide loading
                if (loadingEl) loadingEl.style.display = 'none';

                if (data.albums && data.albums.length > 0) {
                    if (titleEl) {
                        titleEl.textContent = year ? `top albums of ${year}` : `top albums ${startYear}s`;
                    }
                    displayAlbums(data.albums);
                } else {
                    if (noResultsEl) noResultsEl.style.display = 'block';
                } 
            } catch (err) {
                console.error('Widget error:', err);
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) {
                    errorEl.textContent = "failed to load albums";
                    errorEl.style.display = 'block';
                }
            }
        }

        function displayAlbums(albums) {
            if (!gridEl) return;
            gridEl.innerHTML = '';
            gridEl.style.display = 'grid';
            
            albums.forEach((album) => {
                const card = document.createElement('div');
                card.className = 'album-card';
                
                const albumName = album.name || 'Unknown Album';
                const artistName = album.artist || 'Unknown Artist';
                const imageUrl = album.image || '';
                const albumUrl = album.url || '#';
                
                card.onclick = () => { if (albumUrl !== '#') window.open(albumUrl, '_blank'); };
                
                card.innerHTML = `
                    <img src="${imageUrl || 'https://via.placeholder.com/300x300/C4E0E0/4A1DC0?text=no+image'}" 
                         alt="${albumName}" class="album-cover"
                         onerror="this.src='https://via.placeholder.com/300x300/C4E0E0/4A1DC0?text=no+image'">
                    <div class="album-info">
                        <div class="album-name" title="${albumName}">${albumName}</div>
                        <div class="album-artist" title="${artistName}">${artistName}</div>
                    </div>
                `;
                gridEl.appendChild(card);
            });
            
            setTimeout(sendHeight, 200);
        }

        function sendHeight() {
            const height = document.body.scrollHeight || document.body.offsetHeight;
            window.parent.postMessage({ type: 'resize', height: height }, '*');
        }

        loadAlbums();
        window.addEventListener('resize', sendHeight);
    });
</script>